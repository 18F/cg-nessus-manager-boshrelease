#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders
source /var/vcap/jobs/nessus-manager/helpers/ctl_setup.sh 'nessus-manager'

export LANG=en_US.UTF-8

case $1 in

  start)
    pid_guard $PIDFILE $JOB_NAME

    ln -sf /opt/nessus/var/nessus/logs $LOG_DIR

    if [[ ! -f /opt/nessus/sbin/nessuscli ]]; then
      # Install package and remove init scripts in /etc
      dpkg -i /var/vcap/packages/nessus-manager/Nessus-6.7.0-ubuntu1110_amd64.deb
      update-rc.d -f nessusd remove
      rm /etc/init.d/nessusd
      # Add an admin user (be sure to use tabs for indentation here)
      /opt/nessus/sbin/nessuscli adduser <%= p("nessus-manager.username") %> <<-EOF
	<%= p("nessus-manager.password") %>
	<%= p("nessus-manager.password") %>
	y
	
	y
EOF

      # Install the license (do this last in case the license is already used and we exit with non-zero)
      /opt/nessus/sbin/nessuscli fetch --register <%= p("nessus-manager.license") %>
    fi
    NESSUS_PREFIX="/opt/nessus"
    NESSUS_SERVICE=${NESSUS_PREFIX}/sbin/nessus-service

    exec $NESSUS_SERVICE -D -q \
         >>$LOG_DIR/$JOB_NAME.log 2>&1

    ;;

  stop)
    kill_and_wait $PIDFILE

    ;;
  *)
    echo "Usage: ctl {start|stop}"

    ;;

esac
exit 0
